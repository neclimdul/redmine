<VirtualHost *:80>
  ServerName <%= @params[:extra]["server_name"] %>
  ServerAlias <% @params[:server_aliases].each do |server_alias| %><%= server_alias %> <% end %>
  Redirect permanent / https://<%= @params[:extra]["server_name"] %>/
</VirtualHost>

<VirtualHost *:443>
  ServerName <%= @params[:extra]["server_name"] %>
  ServerAlias <% @params[:server_aliases].each do |server_alias| %><%= server_alias %> <% end %>
  DocumentRoot <%= @params[:docroot] %>

  RackBaseURI /
  RailsEnv <%= @params[:rails_env] %>
  PassengerUser "<%= @params[:extra]["passenger_user"] %>"

  # ----------------- #
  # SSL Configuration #
  # ----------------- #

  SSLEngine on

  SSLCertificateFile    <%= @params[:extra]["ssl_cert"] %>
  SSLCertificateKeyFile <%= @params[:extra]["ssl_key"] %>
<% if @params[:extra]["ssl_chain"] %>
  SSLCertificateChainFile <%= @params[:extra]["ssl_chain"] %>
<% end %>

  BrowserMatch "MSIE [2-6]" \
    nokeepalive ssl-unclean-shutdown \
    downgrade-1.0 force-response-1.0
  # MSIE 7 and newer should be able to use keepalive
  BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown

  # Disable weak protocols.
  SSLProtocol ALL -SSLv2 -SSLv3

  <Directory <%= @params[:docroot] %>>
    Options FollowSymLinks
    AllowOverride None
    <% if node['apache']['version'] == '2.4' -%>
    Require all granted
    <% elsif node['apache']['version'] == '2.2' -%>
    Order allow,deny
    Allow from all
    <% end -%>
  </Directory>

  LogLevel info
  ErrorLog <%= node["apache"]["log_dir"] %>/<%= @params[:name] %>-error.log
  CustomLog <%= node["apache"]["log_dir"] %>/<%= @params[:name] %>-access.log combined
</VirtualHost>
